# Implementation Plan: Admin Management Section

**Branch**: `004-admin-management` | **Date**: January 25, 2026 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-admin-management/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command on January 25, 2026.

## Summary

Implement admin management functionality to enable administrators to create, edit, and delete item categories and user accounts. This feature adds role-based access control with two user roles (administrator and standard user), creates a new Category entity to replace string-based categories in Items, and implements audit logging for all administrative actions. The implementation follows Constitution principles for modular architecture, atomic transactions, and RESTful API design.

**Technical Approach**: 
- Migrate existing category strings to a new Category table with foreign key constraints
- Standardize User roles to "administrator" and "standard user" enum values
- Create AdminAuditLog table for compliance tracking
- Implement requireAdmin middleware for route protection
- Build admin section with nested routes (/admin, /admin/categories, /admin/users)
- Use custom Tailwind components following glassmorphism design standards

## Technical Context

**Language/Version**: 
- Backend: Node.js 18+ (CommonJS)
- Frontend: TypeScript 5.9.3 with React 19.2.0

**Primary Dependencies**: 
- Backend: Express 5.2.1, Sequelize 6.37.7, SQLite3 5.1.7, Umzug 3.8.2, Multer 2.0.2, XSS 1.0.15
- Frontend: React Router 7.12.0, Tailwind CSS 4.1.18, TanStack React Query 5.90.19, Axios 1.13.2, Day.js 1.11.19

**Storage**: SQLite 3.x with foreign key constraints enabled (`PRAGMA foreign_keys = ON`)

**Testing**: 
- Backend: Jest 30.2.0 + Supertest 7.2.2
- Frontend: Vitest 4.0.17 + React Testing Library 16.3.1 + MSW 2.12.7

**Target Platform**: Cross-platform web application (Chrome, Firefox, Safari, Edge latest versions)

**Project Type**: Web application (backend + frontend)

**Performance Goals**: 
- Category/user lists display in <2 seconds for up to 1000 entries (SC-006)
- Admin creates category in <30 seconds (SC-001)
- Admin creates user in <60 seconds (SC-002)
- Role changes take effect within 5 seconds (SC-007)

**Constraints**: 
- Atomic transactions for all state-changing operations (Constitution Principle III)
- Foreign key constraints enforced at database level (Constitution Principle IV)
- RESTful API with /api/v1/admin/* versioning (Constitution Principle I)
- Modular architecture with routes→controllers→services→models (Constitution Principle II)
- Role-based access control with middleware (FR-017, FR-018)

**Scale/Scope**: 
- Expected 5-500 users, 10-100 categories
- Unlimited audit logs (5 MB/year estimated growth)
- Admin section: 3 pages (dashboard, categories, users)
- API: 11 endpoints (3 category, 5 user, 1 dashboard, 2 common)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Initial Check (Before Phase 0)

✅ **Principle I: RESTful API Design**
- All admin endpoints follow RESTful conventions
- Resource naming: `/admin/categories`, `/admin/users`
- HTTP verbs: GET (list/read), POST (create), PUT (update), DELETE (remove)
- Versioned under `/api/v1/admin/*`
- Response format: `{ data, error, message }`

✅ **Principle II: Modular Architecture**
- Clear separation: routes → controllers → services → models
- New modules: Category model, AdminAuditLog model, categoryService, userService, emailService, auth middleware
- Services handle business logic (FR-013, FR-014 checks)
- Controllers handle HTTP concerns only

✅ **Principle III: Atomic Transaction Integrity** (NON-NEGOTIABLE)
- All CRUD operations wrapped in transactions
- Category creation: creates record + logs audit entry atomically
- User deletion: checks constraints + deletes + logs atomically
- Category deletion: checks item count + deletes + logs atomically
- Rollback on any failure ensures no partial state changes

✅ **Principle IV: Data Integrity & Constraints**
- Foreign keys: Items.categoryId → Categories.id (ON DELETE RESTRICT)
- Foreign keys: AdminAuditLogs.adminUserId → Users.id (ON DELETE RESTRICT)
- CHECK constraint: Users.role IN ('administrator', 'standard user')
- UNIQUE constraint: Categories.name (case-insensitive)
- Service-layer checks: last admin prevention, self-deletion prevention

✅ **Principle V: Clean Code & Async Operations**
- All database operations use async/await
- Try/catch blocks around service methods
- Descriptive function names (createCategory, deleteUser, requireAdmin)
- No magic numbers (use const for ADMIN_ROLE = 'administrator')

✅ **Principle VI: Component-Based UI Development**
- Functional components only: AdminLayout, AdminDashboard, CategoryManagement, UserManagement
- React Hooks: useState (forms), useQuery (data fetching), custom hooks (useAuth)
- Component composition: AdminCard, ConfirmDialog (reusable)
- No class components

✅ **Principle VII: UI/UX Design Standards**
- Dark theme: bg-slate-900, bg-slate-800/50 (glassmorphism cards)
- Primary colors: #3B82F6 (blue-500 for buttons), #1E293B (slate-800 for surfaces)
- Status badges: muted green/yellow/red with opacity (bg-green-500/20 text-green-400)
- Consistent spacing: p-6, gap-4
- Focus states: ring-2 ring-blue-500
- Accessibility: ARIA labels for icon buttons, keyboard navigation

### Post-Design Check (After Phase 1)

✅ **All Constitution Principles Confirmed**
- Data model enforces foreign keys and check constraints
- API contracts follow RESTful patterns with proper status codes
- Service layer implements transactional boundaries
- Frontend uses functional components with Tailwind styles
- Glassmorphism design applied to admin cards and layouts

**Verdict**: ✅ **Constitution Compliant** - No violations. Implementation ready to proceed.

## Project Structure

### Documentation (this feature)

```text
specs/004-admin-management/
├── spec.md              # Feature specification (user stories, requirements)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 output - technical decisions and patterns
├── data-model.md        # Phase 1 output - database schema and migrations
├── quickstart.md        # Phase 1 output - developer implementation guide
├── contracts/
│   └── api-spec.yaml    # Phase 1 output - OpenAPI 3.0 specification
└── tasks.md             # Phase 2 output (created by /speckit.tasks command)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── Category.js           # NEW - Category entity
│   │   ├── AdminAuditLog.js      # NEW - Audit logging entity
│   │   ├── User.js                # UPDATED - Standardized roles
│   │   ├── Item.js                # UPDATED - categoryId foreign key
│   │   └── index.js               # UPDATED - New associations
│   │
│   ├── services/
│   │   ├── categoryService.js    # NEW - Category CRUD business logic
│   │   ├── userService.js        # NEW - User CRUD with safety checks
│   │   └── emailService.js       # NEW - User notification stub
│   │
│   ├── controllers/
│   │   ├── categoryController.js # NEW - Category HTTP handlers
│   │   ├── userController.js     # NEW - User HTTP handlers
│   │   └── adminController.js    # NEW - Dashboard HTTP handler
│   │
│   ├── routes/
│   │   └── admin.js               # NEW - Admin route group
│   │
│   ├── middleware/
│   │   └── auth.js                # NEW - requireAdmin middleware
│   │
│   ├── db/
│   │   └── migrations/
│   │       ├── YYYYMMDDHHMMSS-create-categories.js          # NEW
│   │       ├── YYYYMMDDHHMMSS-standardize-user-roles.js     # NEW
│   │       └── YYYYMMDDHHMMSS-create-admin-audit-logs.js    # NEW
│   │
│   ├── app.js             # UPDATED - Mount /api/v1/admin routes
│   └── server.js          # No changes
│
└── tests/
    ├── services/
    │   ├── categoryService.test.js  # NEW
    │   └── userService.test.js      # NEW
    └── integration/
        └── admin.test.js             # NEW

frontend/
├── src/
│   ├── api/
│   │   └── adminApi.ts              # NEW - Admin API client
│   │
│   ├── types/
│   │   └── admin.ts                 # NEW - TypeScript interfaces
│   │
│   ├── components/
│   │   └── admin/
│   │       ├── AdminCard.tsx        # NEW - Glassmorphism card component
│   │       └── ConfirmDialog.tsx    # NEW - Confirmation modal
│   │
│   ├── pages/
│   │   └── admin/
│   │       ├── AdminLayout.tsx      # NEW - Admin section layout with auth
│   │       ├── AdminDashboard.tsx   # NEW - Overview stats page
│   │       ├── CategoryManagement.tsx # NEW - Category CRUD page
│   │       └── UserManagement.tsx   # NEW - User CRUD page
│   │
│   └── App.tsx             # UPDATED - Add admin routes
│
└── tests/
    └── pages/
        └── CategoryManagement.test.tsx  # NEW
```

**Structure Decision**: Web application architecture with separate backend (Node.js + Express) and frontend (React + TypeScript). Admin functionality is organized as a feature module within the existing structure:

- **Backend**: New models, services, controllers, and routes under `/admin` prefix
- **Frontend**: New admin section under `/src/pages/admin/` with dedicated layout
- **Database**: Three new migration files to create tables and update existing schemas
- **Testing**: New test files mirror the source structure for admin-specific functionality

This follows the existing modular architecture (Constitution Principle II) while keeping admin features isolated for clarity and maintainability.

## Complexity Tracking

> **No violations detected** - This feature aligns with all Constitution principles.

This section is intentionally left empty as there are no Constitution violations that require justification. The admin management feature follows established patterns:

- **Modular Architecture**: New services, controllers, and routes follow existing separation of concerns
- **RESTful API**: Admin endpoints use standard REST conventions with proper HTTP verbs and status codes
- **Atomic Transactions**: All CRUD operations wrapped in Sequelize transactions per Constitution Principle III
- **Foreign Key Constraints**: All relationships enforced at database level per Constitution Principle IV
- **React Functional Components**: Admin pages use hooks and functional components per Constitution Principle VI
- **Glassmorphism Design**: UI follows established dark theme and component patterns per Constitution Principle VII

**Additional Projects**: None - admin functionality integrates into existing backend and frontend projects.

**Architectural Patterns**: No new patterns introduced - uses existing Sequelize ORM, Express routing, and React component patterns.

**Justification**: N/A - No deviations from Constitution principles.
